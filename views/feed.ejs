<% include ./partials/header.ejs %>
    <div class="main  w-full  min-h-screen bg-zinc-900 text-white py-2 relative">

        <div class="head w-full head px-4 flex items-center justify-between">
            <img class="w-1/4" src="/images/instalogo.png" alt="">
            <div class="icons -mt-2 flex gap-5 items-center">
                <i class="text-[1.4rem] ri-heart-3-line"></i>
                <i class="text-[1.4rem] ri-messenger-line"></i>
            </div>
        </div>
        <div class="story px-3 flex gap-3 overflow-auto mt-5">
            <div class="circle flex-shrink-0">
                <div class="gradient w-[18vw] h-[18vw] bg-sky-100 rounded-full bg-gradient-to-r from-purple-700 to-orange-500 flex items-center justify-center">
                    <div class="inner w-[92%] h-[92%] rounded-full overflow-hidden">
                        <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=2550&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
                    </div>
                </div>
            </div>
            <div class="circle flex-shrink-0">
                <div class="gradient w-[18vw] h-[18vw] bg-sky-100 rounded-full bg-gradient-to-r from-purple-700 to-orange-500 flex items-center justify-center">
                    <div class="inner w-[92%] h-[92%] rounded-full overflow-hidden">
                        <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1570158268183-d296b2892211?q=80&w=3456&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
                    </div>
                </div>
            </div>
            <div class="circle flex-shrink-0">
                <div class="gradient w-[18vw] h-[18vw] bg-sky-100 rounded-full bg-gradient-to-r from-purple-700 to-orange-500 flex items-center justify-center">
                    <div class="inner w-[92%] h-[92%] rounded-full overflow-hidden">
                        <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=2550&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
                    </div>
                </div>
            </div>
            <div class="circle flex-shrink-0">
                <div class="gradient w-[18vw] h-[18vw] bg-sky-100 rounded-full bg-gradient-to-r from-purple-700 to-orange-500 flex items-center justify-center">
                    <div class="inner w-[92%] h-[92%] rounded-full overflow-hidden">
                        <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1570158268183-d296b2892211?q=80&w=3456&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
                    </div>
                </div>
            </div>
            <div class="circle flex-shrink-0">
                <div class="gradient w-[18vw] h-[18vw] bg-sky-100 rounded-full bg-gradient-to-r from-purple-700 to-orange-500 flex items-center justify-center">
                    <div class="inner w-[92%] h-[92%] rounded-full overflow-hidden">
                        <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=2550&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
                    </div>
                </div>
            </div>
            <div class="circle flex-shrink-0">
                <div class="gradient w-[18vw] h-[18vw] bg-sky-100 rounded-full bg-gradient-to-r from-purple-700 to-orange-500 flex items-center justify-center">
                    <div class="inner w-[92%] h-[92%] rounded-full overflow-hidden">
                        <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1570158268183-d296b2892211?q=80&w=3456&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
                    </div>
                </div>
            </div>
        </div>
        <div class="posts mb-20 ">

            <% allposts.reverse().forEach(function(elem){ %>

                <div class="post  mt-10 w-full min-h-[50vh] ">
                    <div class="title  relative flex justify-between items-center">
                        <div class="left flex px-4 items-center gap-2 ">
                            <a href="/openprofile/<%= elem.user.username %>">
                                <div class="w-[8vw] h-[8vw] bg-sky-100 rounded-full overflow-hidden">
                                    <img class="w-full h-full object-cover" src="/images/uploads/<%= elem.user.profile %>" alt="">
                                </div>
                            </a>

                            <a href="/openprofile/<%= elem.user.username %>">
                                <h4 class="text-sm">
                                    <%= elem.user.username %>
                                </h4>
                            </a>
                            <h6 class="text-xs opacity-30">
                                <%= dater(new Date(elem.createdAt)) %>
                            </h6>
                        </div>

                        <div class="right px-2">

                            <% if(elem.user.followers.indexOf(loginuser._id) === -1){  %>
                                <button data-user="<%= elem.user.username %>" class="follow text-white bg-blue-600 px-3 text-sm font-light " style="border-radius: 5px;">Follow</button>
                                <%  }  else {  %>

                                    <button data-user="<%= elem.user.username  %>" class="follow text-white bg-zinc-800 px-3 text-sm font-light " style="border-radius: 5px;">Following</button>
                                    <%  }   %>

                        </div>

                    </div>

                    <div class="w-full h-96 flex items-center justify-center relative mt-4 bg-sky-100 overflow-hidden">
                        <img data-id="<%= elem._id %>" class="postimg w-full h-full object-cover" src="/images/uploads/<%= elem.image %>" alt="">
                    </div>
                    <div class="options  relative w-full px-4 flex justify-between items-center text-[1.4rem]">
                        <div class="flex gap-3 mt-2">

                            <% if(elem.likes.indexOf(loginuser._id) === -1){ %>

                                <i data-id="<%= elem._id %>" class=" like ri-heart-3-line cursor-pointer"></i>
                                <%   }   else {  %>

                                    <i data-id="<%= elem._id %>" class=" like ri-heart-3-fill text-red-500 cursor-pointer"></i>
                                    <%    }  %>

                                        <i data-comments="<%= elem.comments.length %>" data-post="<%= elem %>" data-postid="<%= elem._id %>" id="addtocomment" class="ri-chat-3-line cursor-pointer"></i>
                                        <i class="ri-share-circle-line"></i>
                        </div>
                        <% if(loginuser.savedPosts.indexOf(elem._id) === -1){ %>
                            <i data-id="<%= elem._id %>" class="save ri-bookmark-line cursor-pointer"></i>
                            <%   }   else {   %>
                                <i data-id="<%= elem._id %>" class="save ri-bookmark-fill cursor-pointer"></i>
                                <% } %>

                    </div>
                    <h3 class="px-4 relative mt-2 text-sm leading-none tracking-tight whitespace-nowrap w-fit whitespace-nowrap ">
                        <span class="total-likes main cursor-pointer">
                          <a href="/post/likes/<%= elem._id %>" class="cursor-pointer likedby"><%= elem.likes.length %>  likes </a>
                          </span>
                    </h3>
                    <h2 class="text-white pl-3.5 relative font-light text-sm   mt-2 "><span class="font-semibold  pr-2 whitespace-nowrap"><%= elem.user.username %></span>
                        <%= elem.caption %>
                    </h2>

                    <p id="view-comments" data-all="<%= elem.comments.length %>" data-post="<%= elem._id %>" class="views ml-3.5 font-light text-sm cursor-pointer" style="color: rgba(192, 192, 192, 0.58);">
                        <% if(elem.comments.length == 0){  %>
                            no comments.
                            <%    } else if(elem.comments.length == 1){  %>
                                View all <span><%= elem.comments.length %></span> comment.
                                <%    }   else if(elem.comments.length > 1){  %>
                                    View all <span><%= elem.comments.length %></span> comments.
                                    <%  } %>

                    </p>


                    <div class="latest-comment relative pl-3 ">

                    </div>

                    <% if(elem.comments.length <= 4){  %>
                        <div class="add-comment flex  max-w-full  px-3 mt-2 gap-2 ">
                            <div class="loginproifle max-w-[30px] h-[30px] rounded-full  overflow-hidden">
                                <img class="w-full h-full object-cover " src="/images/uploads/<%= loginuser.profile %>" alt="">
                            </div>
                            <input data-postid="<%= elem._id %>" class="addinp cursor-pointer bg-zinc-900 w-[85%] text-sm font-light" type="text" placeholder="Add a comment for <%=elem.user.username %>" autocomplete="off" style="outline:none; border:none; color:whitesmoke;">
                            <i class=" hidden add-comment  ri-arrow-up-line mt-0.5 text-lg cursor-pointer"></i>

                        </div>
                        <%   }  %>

                            <div class="comments-container hidden w-full  h-screen  bg-zinc-900 absolute top-[0%] left-[0%]  z-[10000]">
                                <div class="top w-full h-[5%]  flex  items-center  justify-between pb-3 " style="border-bottom: 1px solid rgba(192, 192, 192, 0.103);">
                                    <i id="back" class="ri-arrow-left-line text-lg font-light cursor-pointer "></i>
                                    <h3 class="text-lg font-normal  relative right-[18%] ">Comments</h3>
                                </div>

                                <div class="middle w-full  h-[76%]  relative overflow-x-hidden overflow-y-scroll">
                                    <div class="center text-center  my-[8vw]">
                                        <h2 class="text-sm font-light"><span class="text-2xl font-semibold">No comments yet.</span> <br>Start the conversation.</h2>
                                    </div>

                                    <div class="all-comments py-7 px-5 ">

                                    </div>


                                </div>

                                <div class="bottom  w-full  h-[10%] flex items-center gap-4" style="border-top: 1px solid rgba(192, 192, 192, 0.103); z-index: 999;">
                                    <div class="loginprofile w-[55px] h-[55px] rounded-full overflow-hidden relative ">
                                        <img class="w-full h-full object-cover  absolute " src="/images/uploads/<%= loginuser.profile %>" alt="">
                                    </div>
                                    <input id="commentinp" class="cu caption-bottom bg-zinc-900 w-[70%]" autocomplete="off" type="text" placeholder="Add a comment..." style="outline: none; border:none; ">
                                    <div id="commenticon" class="icon hidden ml-4 px-2.5 py-0.5 rounded-3xl flex items-center justify-center " style="background-color: royalblue;">
                                        <i class="ri-arrow-up-line cursor-pointer"></i>
                                    </div>
                                </div>
                            </div>

                </div>

                <%  }) %>

        </div>

    </div>



    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "gilroy";
        }
        
        body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        .like {
            transition: transform cubic-bezier(0.175, 0.885, 0.32, 1.275) 2s;
        }
        
        .story::-webkit-scrollbar {
            display: none;
        }
        
        .middle::-webkit-scrollbar {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js" integrity="sha512-NQfB/bDaB8kaSXF8E77JjhHG5PM6XVRxvHzkZiwl3ddWCEPBa23T76MuWSwAJdMGJnmQqM0VeY9kFszsrBEFrQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" integrity="sha512-7eHRwcbYkK4d9g/6tD/mhkf++eoTHwpNM9woBxtPUBWm67zeAfFC+HrdoE2GanKeocly/VxeLvIqwvCdk7qScg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        let loginuser = `<%= loginuser._id  %>`;


        function handlelike() {
            document.querySelector(".posts").addEventListener("click", function(e) {
                if (e.target.classList.contains(`like`)) {

                    let post = e.target.dataset.id;
                    var icon = e.target;

                    axios.get(`/like/post/${post}`)
                        .then((response) => {
                            if (icon.classList.contains('ri-heart-3-line')) {
                                icon.classList.add('ri-heart-3-fill', 'text-red-500');
                                icon.classList.remove('ri-heart-3-line')
                                icon.classList.add('scale-125');


                            } else {

                                icon.classList.add('ri-heart-3-line');
                                icon.classList.remove('ri-heart-3-fill', 'text-red-500');
                                icon.classList.add('scale-100');


                            }

                            e.target.parentNode.parentNode.parentNode.querySelector('.total-likes').textContent = response.data.likes.length + "   likes";
                        })
                }
            })
        }

        handlelike();


        function saveandunsavepost() {
            document.querySelector(".posts").addEventListener("click", function(e) {

                if (e.target.classList.contains(`save`)) {
                    const post = e.target.dataset.id;
                    axios.get(`/save/${post}`)
                        .then(function(res) {
                            if (e.target.classList.contains('ri-bookmark-line')) {
                                e.target.classList.add('ri-bookmark-fill');
                                e.target.classList.remove('ri-bookmark-line');

                            } else {
                                e.target.classList.add('ri-bookmark-line');
                                e.target.classList.remove('ri-bookmark-fill');

                            }
                        })

                }
            })
        }

        saveandunsavepost();



        let commentsLength;
        let post;
        let postid;
        let previouscomments;

        document.querySelector(".posts").addEventListener("click", function(dets) {
                    if (dets.target.id === "addtocomment") {
                        commentsLength = dets.target.dataset.comments;
                        post = dets.target.dataset.post;
                        postid = dets.target.dataset.postid;

                        document.querySelector(".comments-container").style.display = "initial"
                        document.querySelector(".story").style.display = "none";
                        document.querySelector(".head").style.display = "none";

                        axios.get(`/previous/comments/${postid}`)
                            .then(function(data) {
                                    previouscomments = "";
                                    data.data.forEach(function(previous) {
                                                previouscomments += `<div class="comment-one mb-4 flex justify-between w-[85%] ">
                                <div class="left flex gap-2 ">
                                    <a  href= "/openprofile/${previous.user.username}"><div class="comment-profile mt-1 max-w-[35px] max-h-[35px] rounded-full overflow-hidden">
                                        <img class="w-full h-full object-cover rounded-full" src="/images/uploads/${previous.user.profile}" alt="">
                                    </div></a>
                                        
                                      
                                    <div class="comment-dets flex flex-col ">
                                         <a class= "cursor-pointer" href= "/openprofile/${previous.user.username}"> <h3>${previous.user.username}</h3> </a>
                                        <p class="text-sm font-light whitespace-wrap max-w-xl"> ${previous.text}
                                        </p>
                                    </div>
                                </div>

                            <div  class="right" 
                            ${previous.likes.indexOf(loginuser) === -1 ?
                                `<p><i class="ri-heart-3-line text-silver-600 text-lg"></i></p>` :
                                `<p><i class="ri-heart-3-fill text-lg"></i></p>`
                              }
                           </div>
                            </div>`
                        })

                        document.querySelector(".all-comments").innerHTML = previouscomments;

                    });



                if (commentsLength > 0) {
                    document.querySelector(".center").style.display = "none";

                } else {
                    document.querySelector(".all-comments").style.display = "none";

                }

            }
        })


        let commentinp = document.querySelector("#commentinp");
        let commentIcon = document.querySelector("#commenticon");
        let text;


        commentinp.addEventListener("input", function(e) {
            commentIcon.style.display = "initial";
            text = this.value;
        })

        let clutter;
        let viewcomments2;

        function uploadcomment() {
            commentIcon.addEventListener("click", function(ev) {
                viewcomments2 = ev.target.parentNode.parentNode.previousElementSibling.previousElementSibling.previousElementSibling;
                
                commentinp.value = "";
                document.querySelector(".center").style.display = "none";

                axios.post(`/comment/${text}/${postid}`)
                    .then(response => {
                        clutter = "";

                        viewcomments2.textContent = `view all ${response.data.post.comments.length} comments`;

                        document.querySelector(".all-comments").innerHTML += `<div class="comment-one mb-4 flex justify-between w-[85%] ">
                            <div class="left flex gap-2 ">
                               <a  href= "/openprofile/${response.data.user.username}"> <div class=" comment-profile mt-1 max-w-[35px] max-h-[35px] rounded-full overflow-hidden">
                                <img class="w-full h-full object-cover rounded-full" src="/images/uploads/${response.data.user.profile}" alt="">
                            </div></a>
                                    
                                  
                                <div class="comment-dets flex flex-col ">
                                     <a  href= "/openprofile/${response.data.user.username}"> <h3>${response.data.user.username}</h3></a>
                                    <p class="text-sm font-light whitespace-wrap max-w-xl"> ${response.data.text}
                                    </p>
                                </div>
                            </div>
                            
                        <div  class="right" 
                        ${response.data.likes.indexOf(loginuser) === -1 ?
                            `<p><i class="ri-heart-3-line text-silver-600 text-lg"></i></p>` :
                            `<p><i class="ri-heart-3-fill text-lg"></i></p>`
                          }
                       </div>
                        </div>`



                    })


            })



            document.querySelector("#back").addEventListener("click", function(e) {
                document.querySelector(".comments-container").style.display = "none";
                document.querySelector(".story").style.display = "flex";
                document.querySelector(".head").style.display = "flex";
                document.querySelector(".comments-container .bottom").style.display = "flex";
                

            })
        }
        uploadcomment();
        let totalcomments;
        document.querySelector(".posts").addEventListener("click", function(e) {
                    if (e.target.classList.contains("views")) {
                         document.querySelector(".comments-container .bottom").style.display = "none";

                        if (e.target.dataset.all >= 1) {
                            var postid = e.target.dataset.post
                            document.querySelector(".comments-container").style.display = "block";
                            document.querySelector(".story").style.display = "none";
                            document.querySelector(".head").style.display = "none";
                            document.querySelector(".center").style.display = "none";
                            axios.get(`/comments/${postid}`)
                                .then(function(allcomments) {
                                        totalcomments = "";
                                        allcomments.data.reverse().forEach(function(one) {
                                                    totalcomments += ` <div class="comment-one mb-4 flex justify-between w-[85%] ">
                                    <div class="left flex gap-2 ">
                                       <a href= "/openprofile/${one.user.username}"> <div class=" mt-1 max-w-[35px] max-h-[35px] rounded-full overflow-hidden">
                                        <img class="w-full h-full object-cover rounded-full" src="/images/uploads/${one.user.profile}" alt="">
                                    </div></a>
                                            
                                          
                                        <div class="comment-dets flex flex-col ">
                                           <a href= "/openprofile/${one.user.username}"> <h3>${one.user.username}</h3></a>
                                            <p class="text-sm font-light whitespace-wrap max-w-xl"> ${one.text}
                                            </p>
                                        </div>
                                    </div>
                                   
                                
                                <div  class="right" 
                                ${one.likes.indexOf(loginuser) === -1 ?
                                    `<p><i class="ri-heart-3-line text-silver-600 text-lg"></i></p>` :
                                    `<p><i class="ri-heart-3-fill text-lg"></i></p>`
                                  }

                                </div>
                                
                                </div> `;

                            })

                            document.querySelector(".all-comments").innerHTML = totalcomments;

                        })
                }
            }
        })

        let addCommentIcon;
        let data2;
        let postID;
        let forminput;
        let latestComment;
        let viewcomments;
        document.querySelector(".posts").addEventListener("click", function(ex) {
            if (ex.target.classList.contains("addinp")) {
                postID = ex.target.dataset.postid;
                forminput = ex.target;
                forminput.addEventListener("input", function(event) {
                    addCommentIcon = ex.target.nextElementSibling;
                    latestComment = event.target.parentNode.previousElementSibling;
                    viewcomments = event.target.parentNode.previousElementSibling.previousElementSibling;

                    if (addCommentIcon && addCommentIcon.classList.contains("add-comment")) {
                        addCommentIcon.style.display = "block";
                        data2 = event.target.value;
                    }
                });
            }

            addCommentIcon.addEventListener("click", function(d) {

                forminput.value = "";
                addCommentIcon.style.display = "none";

                axios.post(`/comment/${data2}/${postID}`)
                    .then(function(data) {
                        latestComment.innerHTML = `<h3 class= "cursor-pointer" ><a href="/openprofile/${data.data.user.username}">${data.data.user.username}</a><span class="font-light text-sm ml-2">${data.data.text}</span></h3>`
                        viewcomments.textContent = `view all ${data.data.post.comments.length} comments `;
                    })
            })
        });


        

           function heartaninmation(){
            
                document.querySelector(".posts")
                  .addEventListener("click", function (ev) {
                    if (ev.target.classList.contains('postimg')) {  
                      var hearticon = document.createElement('i');
                      hearticon.classList.add('ri-heart-3-fill', 'text-3xl', 'text-white-600', 'z-[34]');
                      hearticon.style.scale = 2.5;
                      hearticon.style.position = 'absolute';
                      hearticon.style.left = "50%";
                      hearticon.style.top = "50%";
                      hearticon.style.transform = "translate(-50%, -50%)";

                      
                       
                
                      ev.target.parentNode.appendChild(hearticon);
          
                      axios.get(`/like/post/${ev.target.dataset.id}`)
                      .then(function(response){
                        var icon = ev.target.parentNode.parentNode.querySelector('.like');
                        if (icon.classList.contains('ri-heart-3-line')) {
                            icon.classList.remove('ri-heart-3-line');
                            icon.classList.add('ri-heart-3-fill', 'text-red-500');
                          }
                          else {
                            icon.classList.add('ri-heart-3-line');
                            icon.classList.remove('ri-heart-3-fill', 'text-red-500');
                          }
          
                          var likes = ev.target.parentNode.parentNode.querySelector(".total-likes");
                          likes.textContent = response.data.likes.length + ' likes';
                      })
          
                      gsap.from(hearticon, {
                        scale :0,
                        ease: 'linear',
                        duration :1,
                        onComplete: function(){
                          ev.target.parentNode.removeChild(hearticon);
                        }
                      })
                    }
                  })
              }
          
        
          
           heartaninmation();

        
       
        function followUnfollow() {
            document.querySelectorAll(".post").forEach(post => {
                post.addEventListener("click", function(event) {
                    if (event.target.classList.contains("follow")) {
                        let user = event.target.dataset.user;
                        let btn = event.target;
        
                        axios.put(`/follow/${user}`)
                        .then(function(data) {
                            console.log(data.data);
        
                            // Update the button clicked
                            if (btn.classList.contains('bg-blue-600')) {
                                btn.classList.add('bg-zinc-800');
                                btn.classList.remove('bg-blue-600');
                            } else {
                                btn.classList.remove('bg-zinc-800');
                                btn.classList.add('bg-blue-600');
                            }
        
                            if (btn.textContent === "Follow") {
                                btn.textContent = "Following";
                            } else {
                                btn.textContent = "Follow";
                            }
        
                            // Update other buttons associated with the same user
                            let allButtons = document.querySelectorAll(`.post .follow[data-user="${user}"]`);
                            allButtons.forEach(otherBtn => {
                                if (otherBtn !== btn) { // Avoid updating the clicked button again
                                    if (otherBtn.classList.contains('bg-blue-600')) {
                                        otherBtn.classList.add('bg-zinc-800');
                                        otherBtn.classList.remove('bg-blue-600');
                                    } else {
                                        otherBtn.classList.remove('bg-zinc-800');
                                        otherBtn.classList.add('bg-blue-600');
                                    }
        
                                    if (otherBtn.textContent === "Follow") {
                                        otherBtn.textContent = "Following";
                                    } else {
                                        otherBtn.textContent = "Follow";
                                    }
                                }
                            });
                        });
                    }
                });
            });
        }
        
        followUnfollow();
    </script>

    <% include ./partials/footer.ejs %>